<!DOCTYPE html>
<html>
<head>
	<meta charset="utf8">
	<title>NYC Pulse</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
	<script type="text/javascript"
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8LeyaDeV6VXi7os1k-XO_kATNyVkVDQw&sensor=false">
	</script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="{{
  url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
	<script type="text/javascript">

		var data = {{ stops|safe }};
		console.log(data);

		var markers = [];
		// Initialize map
		function initialize() {
			var mapOptions = {
				center: new google.maps.LatLng(40.6700, -73.9400),
				zoom: 16
			};
			var map = new google.maps.Map(document.getElementById("map-canvas"),
				mapOptions);
					// Add stations to map
			console.log('adding stops');
			console.log(new Date().getTime());
			
			// Add markers to map
			var markers = addMarkers(data, map);
			// console.log(markers[1]);
			tick(markers);

		} // End of initialize

		google.maps.event.addDomListener(window, 'load', initialize);

		// Tick
		function tick() {
			console.log('calling tick');
			// console.log(markers);
			var currentTime = new Date();
			console.log('currentTime :', currentTime.getTime());
			var relevantMarkers = [];	// Markers that need to move when clock ticks
			for (var i = 0; i < data.length; i++) { 	// Loop through markers
				var arrivals = data[i].arrivals;
				console.log('arrivals');
				console.log(arrivals);
				for (var j = 0; j < arrivals.length; i++) {	// For each marker, loop through its arrivals 
					console.log('arrivals[j]');
					console.log(arrivals[j]);
					if(sameTime(arrivals[j], currentTime))
						relevantMarkers.push(markers[i]);
				};
			};
			console.log('relevantMarkers');
			console.log(relevantMarkers);
			animate(relevantMarkers);
			// clearInterval(t);
			var t = setTimeout('tick()', 60000);
		}

		
		// Add markers to map
		function addMarkers(data, map) {
			for (var i = 0; i < data.length; i++) {
				var stop = data[i];
				var myLatlng = new google.maps.LatLng(stop['lat'], stop['lon']);
				var marker = new google.maps.Marker({
					position: myLatlng,
					title: stop['name'],
					icon: '/static/train.png'
				});
				markers.push(marker);
				marker.setMap(map);	
			};
			return markers;
		}
	
		// Animation
		function animate(markers) {
			console.log('calling animate');
			// console.log(markers);
			for (var i = 0; i < markers.length; i++) {
				markers[i].setAnimation(google.maps.Animation.DROP);			
			};
		}

		// Check if two times are the same
		// Used to what trains arrive at any given minute
		// Necessary because MTA provides times in non-UTC format
		// trainTime is already formated
		// currentTime is in Time Since Epoch format
		function sameTime(trainTime, currentTime) {
			console.log('calling sameTime');
			var currentHour = currentTime.getHours();
			var currentMin = currentTime.getMinutes();
			console.log('currentHour' + currentHour + 'currentMin' + currentMin);

			var trainTime = trainTime.split(":");
			var trainHour = trainTime[0];
			var trainMin = trainTime[1];
			console.log('trainHour' + trainHour + 'trainMin' + trainMin);

			if((currentHour == trainHour) && (currentMin == trainMin)) {
				return true;
			}
			return false;
		}	
			
	</script>

</head>
<body>
	<div id="map-canvas"/>
</body>
</html>